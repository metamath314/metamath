<script>
    // ... (기존 보안 로직) ...
</script>

<table>
        <thead>
            <tr>
                <th>대학명</th>
                <th>모집단위</th>
                <th>반영비율</th>
                <th>대학별 컷</th>
                <th>내 환산점수</th> <th>차이</th>
                <th>판정</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>

<script>
    // ... (기존 변수들) ...

    function runAnalysis() {
        if (typeof database === 'undefined') return;

        const kor = parseInt(document.getElementById('kor').value) || 0;
        const math = parseInt(document.getElementById('math').value) || 0;
        const eng = parseInt(document.getElementById('eng').value) || 1;
        const t1 = parseInt(document.getElementById('t1').value) || 0;
        const t2 = parseInt(document.getElementById('t2').value) || 0;
        const searchKeyword = document.getElementById('univSearch').value.toLowerCase();
        
        // 단순 합산 (화면 상단 표시용)
        document.getElementById('totalDisplay').innerText = kor + math + t1 + t2;
        
        const body = document.getElementById('resultBody');
        body.innerHTML = '';

        let filtered = database.filter(d => 
            d.group === currentGroup && 
            (d.univ.toLowerCase().includes(searchKeyword) || d.dept.toLowerCase().includes(searchKeyword))
        );

        filtered.forEach(item => {
            // [핵심] 대학별 환산 점수 계산 로직
            // 비율 데이터가 "25/40/15/20" 형태인 경우 추출
            let myConvertedScore = 0;
            if (item.ratio && item.ratio !== "비율정보없음") {
                const r = item.ratio.split('/').map(Number);
                const rKor = r[0] || 0;
                const rMath = r[1] || 0;
                const rEng = r[2] || 0;
                const rTam = r[3] || 0;

                // 1. 국수탐 환산 (비율 가중치 적용)
                // (내점수 * 반영비율)의 총합을 전체 비율 합으로 나눔
                const totalWeight = rKor + rMath + rTam;
                const weightedSum = (kor * rKor) + (math * rMath) + ((t1 + t2) / 2 * rTam);
                
                // 400점 만점 기준으로 환산 (비상 컷이 보통 400점 만점 기준이므로)
                myConvertedScore = (weightedSum / totalWeight); 
                
                // 영어 감점/가산점 단순화 모델 (1등급 기준 0, 등급당 -2점 가정 - 필요시 수정 가능)
                myConvertedScore -= (eng - 1) * 2;
            } else {
                // 비율 정보가 없을 경우 단순 합산 평균으로 처리
                myConvertedScore = (kor + math + (t1 + t2) / 2);
            }

            const finalMyScore = parseFloat(myConvertedScore.toFixed(2));
            const diff = parseFloat((finalMyScore - item.cut).toFixed(2));
            
            let resultTxt, badgeClass;
            if (diff >= 3) { resultTxt = "안정"; badgeClass = "bg-stable"; }
            else if (diff >= -0.5) { resultTxt = "적정"; badgeClass = "bg-fit"; }
            else if (diff >= -3) { resultTxt = "소신"; badgeClass = "bg-ambitious"; }
            else { resultTxt = "위험"; badgeClass = "bg-danger"; }

            body.innerHTML += `<tr>
                <td style="font-weight:bold;">${item.univ}</td>
                <td>${item.dept}</td>
                <td style="font-size:11px; color:#666;">${item.ratio}</td>
                <td style="color:#2d3436;">${item.cut}</td>
                <td style="font-weight:bold; color:var(--primary);">${finalMyScore}</td>
                <td style="font-weight:bold; color:${diff >= 0 ? 'blue' : 'red'}">${diff > 0 ? '+' + diff : diff}</td>
                <td><span class="badge ${badgeClass}">${resultTxt}</span></td>
            </tr>`;
        });
    }
</script>